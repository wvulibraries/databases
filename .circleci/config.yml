version: 2.1

jobs:
  build:
    docker:
      - image: cimg/base:2024.07
    environment:
      TZ: /usr/share/zoneinfo/America/New_York
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Docker Compose
          command: |
            mkdir -p ~/bin
            curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o ~/bin/docker-compose
            chmod +x ~/bin/docker-compose
            echo 'export PATH=~/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Start Services
          command: docker-compose -f docker-compose.dev.yml up -d
      - run:
          name: Wait for services to be ready
          command: |
            dockerize -wait tcp://127.0.0.1:3310 -timeout 1m
            dockerize -wait tcp://127.0.0.1:9200 -timeout 1m
            dockerize -wait tcp://127.0.0.1:5601 -timeout 1m
      # - run:
      #     name: Configure secrets.yml
      #     command: mv config/secrets.ci.yml config/secrets.yml
      # - run:
      #     name: Configure database.yml
      #     command: mv config/database.ci.yml config/database.yml
      - restore_cache:
          name: Restore Yarn Cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install Yarn Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - run:
          name: Install Bundler
          command: |
            gem install bundler
            bundle install --jobs=4 --retry=3
      - restore_cache:
          name: Restore Bundler Cache
          keys:
            - bundler-cache-{{ checksum "Gemfile.lock" }}
      - save_cache:
          name: Save Bundler Cache
          key: bundler-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run:
          name: Precompile assets
          command: bundle exec rake assets:precompile
      - run:
          name: Load DB schema
          command: bin/rails db:schema:load --trace
      - run:
          name: Run Tests
          command: bundle exec rspec
      - store_test_results:
          path: test_results


